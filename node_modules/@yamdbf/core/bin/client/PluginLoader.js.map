{"version":3,"sources":["client/PluginLoader.ts"],"names":[],"mappings":"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","file":"PluginLoader.js","sourcesContent":["import { Client } from './Client';\nimport { Plugin } from './Plugin';\nimport { Logger } from '../util/logger/Logger';\nimport { PluginConstructor } from '../types/PluginConstructor';\n\n/**\n * Loads plugins and holds loaded plugins in case accessing\n * loaded plugins at runtime is desired\n * @param {Client} client\n * @param {Array<PluginConstructor|string>} plugins\n */\nexport class PluginLoader\n{\n\tprivate logger: Logger = Logger.instance();\n\tprivate _client: Client;\n\tprivate _plugins: (PluginConstructor | string)[];\n\tpublic loaded: { [name: string]: any };\n\n\tpublic constructor(client: Client, plugins: (PluginConstructor | string)[])\n\t{\n\t\tthis._client = client;\n\t\tthis._plugins = plugins;\n\n\t\t/**\n\t\t * Object mapping Plugin names to Plugin instances\n\t\t * @type {object}\n\t\t */\n\t\tthis.loaded = {};\n\t}\n\n\t/**\n\t * Loads the plugins passed in the YAMDBF Client options.\n\t * Called internally by the YAMDBF Client at startup\n\t * @private\n\t */\n\tpublic async _loadPlugins(): Promise<void>\n\t{\n\t\tconst tag: string = 'PluginLoader';\n\t\tfor (const [index, plugin] of this._plugins.entries())\n\t\t{\n\t\t\tlet loadedPlugin: Plugin;\n\t\t\tif (typeof plugin === 'string')\n\t\t\t{\n\t\t\t\tlet error: string;\n\t\t\t\tif (!/^yamdbf-/.test(plugin))\n\t\t\t\t{\n\t\t\t\t\ttry { loadedPlugin = new (require(plugin))(this._client); }\n\t\t\t\t\tcatch (err) { error = `${err}, trying 'yamdbf-${plugin}'...`; }\n\n\t\t\t\t\ttry { loadedPlugin = loadedPlugin || new (require(`yamdbf-${plugin}`))(this._client); }\n\t\t\t\t\tcatch (err) { error = error ? `${error}\\n${err}` : err; }\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\ttry { loadedPlugin = new (require(plugin))(this._client); }\n\t\t\t\t\tcatch (err) { error = err; }\n\t\t\t\t}\n\n\t\t\t\tif (!loadedPlugin) {\n\t\t\t\t\tthis.logger.warn(tag, `Failed to load plugin '${plugin}':\\n\\n${error}\\n`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\ttry { loadedPlugin = new plugin(this._client); }\n\t\t\t\tcatch (err)\n\t\t\t\t{\n\t\t\t\t\tthis.logger.warn(tag, `Failed to load plugin at plugins[${index}]:\\n\\n${err}\\n`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof loadedPlugin.name === 'undefined' || loadedPlugin.name === '')\n\t\t\t{\n\t\t\t\tthis.logger.warn(tag, `Plugin at plugins[${index}] is invalid: Missing name`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (typeof loadedPlugin.init === 'undefined')\n\t\t\t{\n\t\t\t\tthis.logger.warn(tag, `Plugin at plugins[${index}] is invalid: Missing init()`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (typeof this.loaded[loadedPlugin.name] !== 'undefined')\n\t\t\t{\n\t\t\t\tthis.logger.warn(tag, `Skipping Plugin at plugins[${index}]: Duplicate name '${loadedPlugin.name}'`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis.logger.info(tag, `Plugin '${loadedPlugin.name}' loaded, initializing...`);\n\t\t\ttry\n\t\t\t{\n\t\t\t\tawait loadedPlugin.init();\n\t\t\t\tthis.logger.info(tag, `Plugin '${loadedPlugin.name}' initialized.`);\n\t\t\t}\n\t\t\tcatch (err)\n\t\t\t{\n\t\t\t\tthis.logger.warn(tag, `Plugin '${loadedPlugin.name}' errored during initialization:\\n\\n${err.stack}`,\n\t\t\t\t\t'\\n\\nPlease report this error to the plugin author.\\n');\n\t\t\t\tthis.logger.info(tag, `Plugin '${loadedPlugin.name}' initialized with errors.`);\n\t\t\t}\n\t\t\tthis.loaded[loadedPlugin.name] = loadedPlugin;\n\t\t}\n\t}\n}\n"],"sourceRoot":"../../src"}